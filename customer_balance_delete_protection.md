# 🛡️ حماية حذف العملاء مع الأرصدة المستحقة

## 🎯 **الهدف:**
منع حذف العملاء الذين عليهم أرصدة مستحقة مع إظهار رسائل تحذيرية واضحة وتوفير بدائل للتعامل مع الرصيد.

## ✅ **التحديثات المطبقة:**

### 1. تحديث منطق الحذف في الخادم:
```python
@app.route('/customers/delete/<int:id>', methods=['POST'])
@login_required
@permission_required('can_delete_records')
def delete_customer(id):
    try:
        customer = Customer.query.get_or_404(id)

        # حساب الرصيد المستحق على العميل
        customer_balance = customer.get_balance()
        
        # التحقق من وجود رصيد مستحق
        if customer_balance > 0:
            flash(f'لا يمكن حذف العميل {customer.name} لأن عليه مبلغ مستحق قدره {customer_balance:.2f} ريال. يجب تسوية الرصيد أولاً أو يمكنك إلغاء تفعيله بدلاً من حذفه.', 'error')
            return redirect(url_for('customers'))

        # باقي عمليات التحقق والحذف...
```

### 2. تحديث واجهة المستخدم:

#### **أ. إضافة عمود الرصيد المستحق:**
- ✅ عمود جديد يظهر الرصيد المستحق لكل عميل
- ✅ **مسدد** (أخضر) للعملاء بدون أرصدة
- ✅ **المبلغ بالريال** (أحمر) للعملاء مع أرصدة مستحقة

#### **ب. مؤشرات بصرية في الجدول:**
- ✅ **خلفية صفراء** للصفوف التي تحتوي على عملاء مع أرصدة مستحقة
- ✅ **أيقونة تحذير** بجانب اسم العميل الذي عليه رصيد
- ✅ **تلميح نصي** عند التمرير على الأيقونة

#### **ج. تحديث أزرار الحذف:**
- ✅ **زر أحمر عادي** للعملاء بدون أرصدة (يمكن حذفهم)
- ✅ **زر أصفر تحذيري** للعملاء مع أرصدة (لا يمكن حذفهم)
- ✅ **تلميح نصي** يوضح سبب عدم إمكانية الحذف

### 3. تحديث نافذة تأكيد الحذف:

#### **أ. رسائل تحذيرية ذكية:**
```html
{% set customer_balance = customer.get_balance() %}
{% if customer_balance > 0 %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>تحذير:</strong> يوجد مبلغ مستحق على هذا العميل قدره <strong>{{ "%.2f"|format(customer_balance) }} ريال</strong>
    <br>
    <small>لا يمكن حذف العميل حتى يتم تسوية الرصيد المستحق.</small>
</div>
{% endif %}
```

#### **ب. معلومات العلاقات المرتبطة:**
- ✅ عرض عدد فواتير المبيعات المرتبطة
- ✅ عرض عدد الدفعات المرتبطة
- ✅ تحذير واضح من العلاقات الموجودة

#### **ج. أزرار ذكية:**
- ✅ **زر "حذف"** يظهر فقط للعملاء بدون أرصدة مستحقة
- ✅ **زر "تسوية الرصيد"** يظهر للعملاء مع أرصدة مستحقة
- ✅ توجيه مباشر لصفحة المدفوعات لتسوية الرصيد

## 🎨 **التحسينات البصرية:**

### 1. ألوان ومؤشرات:
- 🟢 **أخضر:** العملاء المسددين (يمكن حذفهم)
- 🟡 **أصفر:** العملاء مع أرصدة مستحقة (تحذير)
- 🔴 **أحمر:** رسائل الخطر والتحذيرات المهمة

### 2. أيقونات واضحة:
- ⚠️ **أيقونة تحذير:** للعملاء مع أرصدة مستحقة
- 💰 **أيقونة المال:** لزر تسوية الرصيد
- 🗑️ **أيقونة الحذف:** للعملاء القابلين للحذف

### 3. تلميحات نصية:
- ✅ تلميحات عند التمرير على الأيقونات
- ✅ شرح واضح لسبب عدم إمكانية الحذف
- ✅ إرشادات للخطوات التالية

## 🧪 **سيناريوهات الاختبار:**

### 1. عميل بدون رصيد مستحق:
1. **الجدول:** صف عادي، badge أخضر "مسدد"
2. **زر الحذف:** أحمر عادي
3. **نافذة الحذف:** زر حذف متاح
4. **النتيجة:** يُحذف بنجاح

### 2. عميل مع رصيد مستحق:
1. **الجدول:** صف أصفر، badge أحمر بالمبلغ، أيقونة تحذير
2. **زر الحذف:** أصفر تحذيري
3. **نافذة الحذف:** رسالة تحذيرية، زر تسوية الرصيد
4. **النتيجة:** لا يُحذف، توجيه لتسوية الرصيد

### 3. عميل مع مبيعات ومدفوعات:
1. **نافذة الحذف:** عرض تفاصيل العلاقات
2. **التحذير:** رسالة واضحة عن العلاقات المرتبطة
3. **النتيجة:** لا يُحذف، اقتراح إلغاء التفعيل

## 🔧 **كيفية الاستخدام:**

### للمدير:
1. **افتح قائمة العملاء**
2. **لاحظ المؤشرات البصرية:**
   - العملاء مع خلفية صفراء لديهم أرصدة مستحقة
   - العملاء مع badge أحمر لديهم مبالغ مستحقة
3. **للحذف:**
   - العملاء مع زر أحمر: يمكن حذفهم مباشرة
   - العملاء مع زر أصفر: يجب تسوية الرصيد أولاً

### لتسوية الأرصدة:
1. **اضغط على زر الحذف للعميل مع رصيد مستحق**
2. **ستظهر نافذة تحذيرية مع تفاصيل الرصيد**
3. **اضغط "تسوية الرصيد"**
4. **ستنتقل لصفحة المدفوعات**
5. **أدخل المبلغ المطلوب**
6. **بعد التسوية، يمكن حذف العميل**

## 🎯 **الفوائد:**

### 1. حماية البيانات:
- ✅ منع فقدان معلومات الأرصدة المستحقة
- ✅ حماية من الحذف العرضي للعملاء المهمين
- ✅ ضمان تسوية جميع الأرصدة قبل الحذف

### 2. تجربة مستخدم محسنة:
- ✅ مؤشرات بصرية واضحة
- ✅ رسائل تحذيرية مفهومة
- ✅ إرشادات واضحة للخطوات التالية

### 3. إدارة مالية أفضل:
- ✅ متابعة دقيقة للأرصدة المستحقة
- ✅ منع ضياع المستحقات
- ✅ تسهيل عملية التحصيل

## 🌐 **اختبار النظام:**
**http://127.0.0.1:5000/customers**

**معلومات تسجيل الدخول:**
- **مدير النظام:** `admin` / `admin123`

---

**ملاحظة:** النظام الآن يحمي بشكل كامل من حذف العملاء مع الأرصدة المستحقة! 💰🛡️
